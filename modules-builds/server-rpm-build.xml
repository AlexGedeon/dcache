<project name="server-rpm-build">

    <!-- RPM related constants -->
    <!-- modify values in property file ant not here -->
    <property file="modules-builds/rpms.properties" />

    <target name="server.rpm" depends="install-server" description="Build the dcache-server-xxx.rpm">

        <!-- Create config files for RPM from Templates -->

        <copy todir="${server.rpmTopDir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <or>
                    <filename name="rpm*.template" />
                    <filename name="dcache-server.spec.template" />
                </or>
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="rpmMacrosFile" value="${server.rpmMacrosFile}" />
                <!-- This is only used in the rpmrc file -->

                <filter token="rpmRpmDir" value="${rpmRpmDir}" />
                <!-- These are used in the rpmmacros file -->
                <filter token="rpmSrpmDir" value="${rpmSrpmDir}" />
                <filter token="rpmTopDir" value="${server.rpmTopDir}" />

                <filter token="Version" value="${version}" />
                <filter token="Release" value="${build.number}" />
            </filterset>
        </copy>

        <copy file="${rpmTemplateDir}/dcache.bash-completion"
              tofile="${server.root.dir}/etc/bash_completion.d/dcache"/>

        <exec executable="rpmbuild" failonerror="true">
            <!-- output="${buildDir}/rpm.log" -->
            <arg value="--buildroot" />
            <arg file="${server.root.dir}" />
            <arg value="--rcfile" />
            <arg file="/usr/lib/rpm/rpmrc:${server.rpmRcFile}" />
            <!-- some documentation claims that /usr/lib/rpm/rpmrc
                                                            will always be parsed. But it currently isnt if not set here -->
            <arg value="-bb" />
            <arg file="${server.rpmSpecFile}" />
        </exec>

    </target>

    <target name="server-fhs.rpm" depends="install-server-fhs"
            description="Build the dcache-server-xxx.rpm">

        <!--  timestamp for the changelog -->
        <tstamp>
            <format property="timestamp" pattern="EEE MMM dd yyyy"
                    locale="en,UK"/>
        </tstamp>

        <!-- Create config files for RPM from Templates -->

        <copy todir="${server.rpmTopDir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <or>
                    <filename name="rpm*.template" />
                    <filename name="dcache-server-fhs.spec.template" />
                </or>
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Timestamp" value="${timestamp}" />

                <filter token="rpmMacrosFile" value="${server.rpmMacrosFile}" />
                <!-- This is only used in the rpmrc file -->

                <filter token="rpmRpmDir" value="${rpmRpmDir}" />
                <!-- These are used in the rpmmacros file -->
                <filter token="rpmSrpmDir" value="${rpmSrpmDir}" />
                <filter token="rpmTopDir" value="${server.rpmTopDir}" />

                <filter token="Version" value="${version}" />
                <filter token="Release" value="${build.number}" />
            </filterset>
        </copy>

        <mkdir dir="${server.root.dir}/etc/rc.d/init.d"/>
        <copy file="${rpmTemplateDir}/dcache-server.init"
              tofile="${server.root.dir}/etc/rc.d/init.d/dcache-server"/>
        <copy file="${rpmTemplateDir}/dcache.bash-completion"
              tofile="${server.root.dir}/etc/bash_completion.d/dcache"/>

        <exec executable="rpmbuild" failonerror="true">
            <!-- output="${buildDir}/rpm.log" -->
            <arg value="--buildroot" />
            <arg file="${server.root.dir}" />
            <arg value="--rcfile" />
            <arg file="/usr/lib/rpm/rpmrc:${server.rpmRcFile}" />
            <!-- some documentation claims that /usr/lib/rpm/rpmrc
                                                            will always be parsed. But it currently isnt if not set here -->
            <arg value="-bb" />
            <arg file="${server.rpmTopDir}/dcache-server-fhs.spec" />
        </exec>

    </target>

</project>
