<project name="server-fhs" basedir=".">

    <target name="-dcache-copy-skel-fhs">
        <!-- Create targer directories -->
        <mkdir dir="${server.root.dir}/usr/bin"/>
        <mkdir dir="${server.root.dir}/usr/sbin"/>
        <mkdir dir="${server.root.dir}/usr/share/doc"/>
        <mkdir dir="${server.root.dir}/usr/share/dcache/defaults"/>
        <mkdir dir="${server.root.dir}/usr/share/dcache/lib"/>
        <mkdir dir="${server.root.dir}/usr/lib/dcache"/>
        <mkdir dir="${server.root.dir}/etc/dcache/admin"/>
        <mkdir dir="${server.root.dir}/var/log/dcache"/>
        <mkdir dir="${server.root.dir}/var/lib/dcache/config"/>
        <mkdir dir="${server.root.dir}/var/lib/dcache/billing"/>
        <mkdir dir="${server.root.dir}/var/lib/dcache/statistics"/>
        <mkdir dir="${server.root.dir}/var/lib/dcache/credentials"/>

        <!-- Copy skel files to proper locations -->
        <copy todir="${server.root.dir}/usr/bin">
            <fileset dir="${skelDir}/bin"
                     excludes="dCacheConfigure.sh"/>
            <filterset filtersfile="common/fhs-layout.properties"/>
        </copy>
        <move todir="${server.root.dir}/usr/bin">
            <fileset dir="${server.root.dir}/usr/bin"/>
            <mapper type="glob" from="*.sh" to="*"/>
        </move>
        <copy todir="${server.root.dir}/etc/dcache/">
            <fileset dir="${skelDir}/etc"
                     excludes="PlotConfiguration.xml"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/man">
            <fileset dir="${skelDir}/share/man"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/doc/dcache-server">
            <fileset dir="${skelDir}/share/doc"
                     excludes="dCacheConfigure/**"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/dcache/defaults">
            <fileset dir="${skelDir}/share/defaults"/>
            <filterset filtersfile="common/fhs-layout.properties"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/dcache/lib">
            <fileset dir="${skelDir}/share/lib"
                     excludes="dCacheConfigure/**"/>
            <filterset filtersfile="common/fhs-layout.properties"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/dcache">
            <fileset dir="${skelDir}/share"
                     excludes="man/**,doc/**,dCacheConfigure/**,defaults/**,lib/**"/>
        </copy>
        <copy file="${skelDir}/libexec/infoProvider/info-based-infoProvider.sh"
              tofile="${server.root.dir}/usr/sbin/dcache-info-provider">
            <filterset filtersfile="common/fhs-layout.properties"/>
        </copy>
        <copy todir="${server.root.dir}/usr/share/dcache/lib">
            <fileset dir="${skelDir}/libexec"
                     excludes="infoProvider/info-based-infoProvider.sh"/>
            <filterset filtersfile="common/fhs-layout.properties"/>
        </copy>
        <copy todir="${server.root.dir}/etc/bash_completion.d/">
            <fileset dir="${resourcesDir}/etc/bash_completion.d/">
                <include name="**/*"/>
            </fileset>
        </copy>
    </target>

    <target name="install-server-fhs"
            depends="-dcache-copy-skel-fhs,dcache,javatunnel,
                     -dcache-classpath"
            description="build deploy-ready server package">

        <!-- Move files created during build to FHS locations -->
        <move file="${server.bin.dir}/libexec/chimera"
              todir="${server.root.dir}/usr/share/dcache/"/>
        <move file="${server.bin.dir}/classes"
              todir="${server.root.dir}/usr/share/dcache/"/>
        <move file="${server.bin.dir}/share/defaults/classpath.properties"
              todir="${server.root.dir}/usr/share/dcache/defaults"/>
        <move file="${server.bin.dir}/jobs"
              tofile="${server.root.dir}/usr/share/dcache/lib">
            <filterset filtersfile="common/fhs-layout.properties"/>
        </move>
        <move includeEmptyDirs="true"
              file="${server.bin.dir}/etc/users"
              todir="${server.root.dir}/etc/dcache/admin/"/>
        <move file="${server.bin.dir}/share/httpd/static/images/bg.svg"
              todir="${server.root.dir}/usr/share/dcache/httpd/static/images/"/>

        <delete dir="${server.root.dir}/opt"/>

        <chmod dir="${server.root.dir}/usr/bin" includes="*" perm="ugo+rx"/>
        <chmod dir="${server.root.dir}/usr/sbin" includes="*" perm="ugo+rx"/>
        <chmod dir="${server.root.dir}/usr/share/dcache/lib"
               includes="encp.sh,hsmcp.sh,hsmcpV4.sh,migrate-from-1.9.5.sh,migration-check.sh,nsp-performance.sh,preparePnfs.sh,upgrade_space_manager_schema.sh,wait-for-cells.sh,daemon" perm="ugo+rx"/>
        <chmod dir="${server.root.dir}/usr/share/dcache/lib" includes="**/*.rb" perm="ugo+rx"/>
    </target>
</project>
