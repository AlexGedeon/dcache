<!--
      note that dh_* is needed to build these debian packages
      On Debian/Ubuntu it is available in package debhelper.
 -->
<project name="server-deb-build-new">
    <property file="modules-builds/deb.properties" />

    <target name="-server.deb-common">
        <!--  timestamp for the changelog -->
        <tstamp>
            <format property="timestamp" pattern="EEE, dd MMM yyyy HH:mm:ss Z"
                    locale="en,UK"/>
        </tstamp>

        <!-- In Debian the ~ symbol is ordered before any other
             string, even the empty string. So 2.0~SNAPSHOT is smaller
             than 2.0. -->
        <exec executable="sed" inputstring="${pom.version}" outputproperty="deb.version">
            <arg value="s/-/~/g"/>
        </exec>
    </target>

    <!-- debian package with debian compliant file structure -->
    <target name="server.deb"
            depends="install-server,-server.deb-common"
        description="Build a Debian policy compliant dcache-xxx.deb">

        <tstamp>
            <format property="quilt-timestamp-orig" offset="-5" unit="second" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>
        <tstamp>
            <format property="quilt-timestamp" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>

        <!--  move the package contents -->
        <move file="${server.root.dir}" tofile="${server.debDistDir}"/>

        <copy todir="${server.debDistDir}/debian" overwrite="true">
            <fileset dir="${server.debTemplateDir}">
                <filename name="*.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Version" value="${deb.version}-${build.number}" />
                <filter token="MaintainerName" value="${server.debMaintainer}" />
                <filter token="MaintainerMail" value="${server.debMaintainerMail}" />
                <filter token="Timestamp" value="${timestamp}" />
                <filter token="PackageName" value="${server.packageName}" />
            </filterset>
        </copy>

        <chmod file="${server.debDistDir}/debian/rules" perm="0755" />

        <exec executable="dpkg-buildpackage" failonerror="true"
              dir="${server.debDistDir}">
            <!--  don't produce any source packages  -->
            <arg line="-rfakeroot -uc -A" />
        </exec>

        <!--  delete temporary files -->
        <delete dir="${server.debDistDir}" />
    </target>
</project>
