<!--
      note that dh_* is needed to build these debian packages
      On Debian/Ubuntu it is available in package debhelper.
 -->
<project name="server-deb-build-new">
    <property file="common/deb.properties" />

    <target name="-server.deb-common" depends="install-server">
        <!--  timestamp for the changelog -->
        <tstamp>
            <format property="timestamp" pattern="EEE, dd MMM yyyy HH:mm:ss Z"
                    locale="en,UK"/>
        </tstamp>

        <!--  copy the package contents -->
        <copy todir="${server.debDistDir}"
              overwrite="true">
            <fileset dir="${server.root.dir}" includes="**/*" />
        </copy>

        <!--  give the package files the right permissions -->
        <chmod perm="0755">
            <filelist dir="${server.debFilesDir}"
                      files="${server.debExecutableFiles}" />
        </chmod>
    </target>

    <target name="server.deb" depends="-server.deb-common"
        description="Build the dcache-server-xxx.deb">

        <!--  copy the package control files, replace variables -->
        <copy todir="${server.debControlDir}" overwrite="true">
            <fileset dir="${server.debTemplateDir}">
                <filename name="*.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Version" value="${version}-${patch}" />
                <filter token="MaintainerName" value="${server.debMaintainer}" />
                <filter token="MaintainerMail" value="${server.debMaintainerMail}" />
                <filter token="Timestamp" value="${timestamp}" />
                <filter token="PackageName" value="${server.packageName}" />
            </filterset>
        </copy>

        <chmod file="${server.debControlDir}/rules" perm="0755" />

        <exec executable="dpkg-buildpackage" failonerror="true"
              dir="${server.debDistDir}">
            <!--  don't produce any source packages  -->
            <arg line="-rfakeroot -uc -A" />
        </exec>

        <!--  delete temporary files -->
        <delete dir="${server.debDistDir}" />
    </target>

    <!-- debian package with debian compliant file structure -->
    <target name="server-fhs.deb" depends="-server.deb-common"
        description="Build a Debian FHS policy compliant dcache-server-xxx.deb">
        <tstamp>
            <format property="quilt-timestamp-orig" offset="-5" unit="second" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>
        <tstamp>
            <format property="quilt-timestamp" pattern="yyyy-MM-dd HH:mm:ss" />
        </tstamp>

        <!-- copy the copyright and compat from the server folder (same for
              all types of packages) -->
        <copy todir="${server.debControlDir}" overwrite="true">
            <filelist dir="${server.debTemplateDir}"
                      files="changelog.template,
                             compat.template,
                             copyright.template" />
            <fileset dir="${server.debFHSTemplateDir}">
                <filename name="*.template" />
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="Version" value="${version}-${patch}" />
                <filter token="MaintainerName" value="${server.debMaintainer}" />
                <filter token="MaintainerMail" value="${server.debMaintainerMail}" />
                <filter token="Timestamp" value="${timestamp}" />
                <filter token="PackageName" value="${server.packageName}" />
            </filterset>
        </copy>

        <mkdir dir="${server.debPatchDir}" />
        <copy todir="${server.debPatchDir}">
            <fileset dir="${server.debFHSTemplateDir}/patches" />
            <filterset>
                <filter token="DebPatchRoot" value="${server.debPatchRoot}" />
                <filter token="TimestampOrig" value="${quilt-timestamp-orig}" />
                <filter token="Timestamp" value="${quilt-timestamp}" />
            </filterset>
        </copy>

        <chmod file="${server.debControlDir}/rules" perm="0755" />

        <exec executable="dpkg-buildpackage" failonerror="true"
              dir="${server.debDistDir}">
            <!--  don't produce any source packages  -->
            <arg line="-rfakeroot -uc -A" />
        </exec>

        <!--  delete temporary files -->
        <delete dir="${server.debDistDir}" />
    </target>
</project>
