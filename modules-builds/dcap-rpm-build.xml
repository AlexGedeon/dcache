<!-- $Id: build.xml,v 1.60 2007-10-26 12:22:06 tigran Exp $ -->

<project name="dcap-rpm" default="help" basedir=".">

    <!-- dcap ONLY -->
    <target name="dcap32.rpm" depends="install-dcap32" description="Build the dcache-dcap-xxx.rpm">


        <!-- Create config files for RPM from Templates -->

        <copy todir="${dcapclient.rpmTopDir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <or>
                    <filename name="rpm*.template" />
                    <filename name="dcache-dcap.spec.template" />
                </or>
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="rpmMacrosFile" value="${dcapclient.rpmMacrosFile}" />
                <!-- This is only used in the rpmrc file -->

                <filter token="rpmRpmDir" value="${rpmRpmDir}" />
                <!-- These are used in the rpmmacros file -->
                <filter token="rpmSrpmDir" value="${rpmSrpmDir}" />
                <filter token="rpmTopDir" value="${dcapclient.rpmTopDir}" />

                <filter token="Version" value="${version}" />
                <filter token="Release" value="${patch}" />
                <filter token="Arch" value="i586" />

            </filterset>
        </copy>

        <!-- Call RPM. The rpm task is not sufficient since it doesnt have the rcfile option -->

        <exec executable="rpmbuild" failonerror="true">
            <!-- output="${buildDir}/rpm.log" -->
            <arg value="--buildroot" />
            <arg file="${package.root.dir}/dcap" />
            <arg value="--rcfile" />
            <arg file="/usr/lib/rpm/rpmrc:${dcapclient.rpmRcFile}" />
            <!-- some documentation claims that /usr/lib/rpm/rpmrc
                                                        will always be parsed. But it currently isnt if not set here -->
            <arg value="-bb" />
            <arg file="${dcap.rpmSpecFile}" />
        </exec>

    </target>

    <target name="dcap64.rpm" depends="install-dcap64" description="Build the dcache-dcap64-xxx.rpm">


        <!-- Create config files for RPM from Templates -->

        <copy todir="${dcapclient.rpmTopDir}" overwrite="true">
            <fileset dir="${rpmTemplateDir}">
                <or>
                    <filename name="rpm*.template" />
                    <filename name="dcache-dcap.spec.template" />
                </or>
            </fileset>
            <mapper type="glob" from="*.template" to="*" />
            <filterset>
                <filter token="rpmMacrosFile" value="${dcapclient.rpmMacrosFile}" />
                <!-- This is only used in the rpmrc file -->

                <filter token="rpmRpmDir" value="${rpmRpmDir}" />
                <!-- These are used in the rpmmacros file -->
                <filter token="rpmSrpmDir" value="${rpmSrpmDir}" />
                <filter token="rpmTopDir" value="${dcapclient.rpmTopDir}" />

                <filter token="Version" value="${version}" />
                <filter token="Release" value="${patch}" />
                <filter token="Arch" value="x86_64" />
            </filterset>
        </copy>

        <!-- Call RPM. The rpm task is not sufficient since it doesnt have the rcfile option -->

        <exec executable="rpmbuild" failonerror="true">
            <!-- output="${buildDir}/rpm.log" -->
            <arg value="--buildroot" />
            <arg file="${package.root.dir}/dcap" />
            <arg value="--rcfile" />
            <arg file="/usr/lib/rpm/rpmrc:${dcapclient.rpmRcFile}" />
            <!-- some documentation claims that /usr/lib/rpm/rpmrc
                                                        will always be parsed. But it currently isnt if not set here -->
            <arg value="-bb" />
            <arg file="${dcap.rpmSpecFile}" />
        </exec>

    </target>

</project>
