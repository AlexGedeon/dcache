<!-- $Id: junit-build.xml,v 1.4 2007-10-25 14:05:31 tigran Exp $ -->

<project name="junit" basedir="."
         xmlns:artifact="antlib:org.apache.maven.artifact.ant">

    <property name="unittest.build.dir" location="${buildDir}/junit" />

    <artifact:dependencies pathId="junit.maven.classpath" filesetId="junit.maven.fileset" useScope="test">
        <localRepository id="local" path="${m2.home}" />

        <dependency groupId="org.hamcrest" artifactId="hamcrest-library" version="1.3.RC2" scope="test"/>
        <dependency groupId="org.mockito" artifactId="mockito-core" version="1.9.0" scope="test"/>
        <dependency groupId="junit" artifactId="junit" version="4.10" scope="test"/>
    </artifact:dependencies>

    <!-- JUnit test suite -->

    <path id="junit.classpath">
        <pathelement location="${classesDir}/cells.jar" />
        <pathelement location="${classesDir}/dcache.jar" />
        <pathelement location="${classesDir}/dcache-common.jar" />
        <pathelement location="${classesDir}/gplazma.jar" />
        <pathelement location="${classesDir}/srm.jar" />
        <pathelement location="${libDir}/Chimera/chimera-acl.jar" />
        <pathelement location="${libDir}/Chimera/oncrpc.jar" />
        <pathelement location="${libDir}/cog/cog-srmlib/cog-jglobus-1.6.jar" />
        <fileset dir="${libDir}/parboiled4j" includes="**/*.jar" />
        <fileset dir="${libDir}/cog" includes="**/*.jar" />
        <pathelement location="${unittest.build.dir}" />
        <pathelement location="${webappBuildDir}/webadmin.jar" />
        <fileset dir="${libDir}/wicket/" includes="*.jar" />
        <pathelement location="${libDir}/jing/jing-20091111.jar" />
        <pathelement location="${unittest.src}"/>
        <path refid="dependency.classpath" />
        <path refid="junit.maven.classpath" />
    </path>


    <!--
        compile junit tests
    -->
    <target name="-compile.junit">

        <mkdir dir="${unittest.build.dir}" />
        <javac classpathref="junit.classpath" destdir="${unittest.build.dir}" source="${javac.source}" target="${javac.target}" debug="${javac.debug}" verbose="${javac.verbose}" encoding="${javac.encoding}" deprecation="on">
            <src path="${unittest.src}:${gplazma.unittest.src}" />
        </javac>
    </target>


    <!--
        run all avalible tests, or run a single one, or run all in a package
    -->
    <target name="-run.junit" depends="-compile.junit">
        <property name="testdir" value=""/>
        <property name="tests.report.home" location="${buildDir}/junit-reports" />
        <mkdir dir="${tests.report.home}" />

        <junit fork="true">
            <classpath refid="junit.classpath" />
            <sysproperty key="logback.configurationFile" value="${unittest.log}"/>
            <formatter type="xml" usefile="true" />
            <formatter type="brief" usefile="false" />
            <test name="${testcase}" if="testcase" todir="${tests.report.home}" />
            <batchtest todir="${tests.report.home}" haltonfailure="no" unless="testcase">
                <fileset dir="${unittest.build.dir}">
                    <!--include only Classes ending with Test or Tests - -->
                    <!--only these are valid testclasses, everything else are helpers -->
                    <include name="${testdir}**/*Test.class" />
                    <include name="${testdir}**/*Tests.class" />
                    <!--exclude only locally running pinmanager-test-->
                    <exclude name="org/dcache/tests/pinmanager/PinManagerTest.class" />
                </fileset>
            </batchtest>
        </junit>

    </target>
</project>
