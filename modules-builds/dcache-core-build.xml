<!-- $Id: dcache-core-build.xml,v 1.45 2008-10-05 09:22:38 behrmann Exp $ -->

<project name="Core" default="help" basedir=".">

    <property name="dcache.build.dir" location="${buildDir}/dcache" />
    <!--
          Properties  -  the following properties, paths, and selectors
                         define the locations and files for dCache
    -->

    <!-- Output Files
       For each of these jar files there are targets below -->

    <property name="dcache.jar" location="${classesDir}/dcache.jar" />

	<target name="-isUptodate.dcache.jar" depends="-isUptodate.dcache.jar-classes,-isUptodate.dcache.jar-confs">
		<condition property="dcache.jar.upToDate">
			<and>
				<isset property="dcache.jar.upToDate-classes" />
				<isset property="dcache.jar.upToDate-confs" />
			</and>
		</condition>
	</target>

    <target name="-isUptodate.dcache.jar-classes">
        <condition property="dcache.jar.upToDate-classes">
            <and>
                <available file="${dcache.jar}" type="file" />
                <uptodate targetfile="${dcache.jar}">
                    <srcfiles dir="${dcache.src}">
                        <include name="**/*.java" />
                    </srcfiles>
                </uptodate>
            </and>
        </condition>
    </target>

	<target name="-isUptodate.dcache.jar-confs">
        <condition property="dcache.jar.upToDate-confs">
            <and>
                <available file="${dcache.jar}" type="file" />
                <uptodate targetfile="${dcache.jar}">
                    <srcfiles dir="${dcache.src}">
                        <include name="**/*.xml" />
                        <include name="**/*.jdo" />
                    </srcfiles>
                </uptodate>
            </and>
        </condition>
    </target>

    <target name="-isDependPresent">
        <whichresource class="org.apache.tools.ant.taskdefs.optional.jdepend.JDependTask" property="depend.present" />
    </target>

    <!-- Classpath for dcache.jar -->

    <path id="chimera.classpath">
        <pathelement location="${classesDir}/gplazma.jar" />
        <pathelement location="${libDir}/Chimera/chimera-core.jar" />
        <pathelement location="${libDir}/Chimera/oncrpc.jar" />
        <pathelement location="${libDir}/Chimera/portmap.jar" />
    </path>

    <path id="dcache.classpath">
        <path refid="cells.classpath" />
        <path refid="chimera.classpath" />
        <path refid="dependency.classpath" />
        <pathelement location="${classesDir}/dcache-common.jar" />
        <pathelement location="${classesDir}/cells.jar" />
        <pathelement location="${classesDir}/srm.jar" />
        <pathelement location="${classesDir}/gplazma.jar" />
        <fileset dir="${libDir}/wicket/" includes="*.jar" />
        <pathelement location="${libDir}/smc/statemap.jar" />
        <fileset dir="${libDir}/parboiled4j/" includes="*.jar" />
        <pathelement location="${libDir}/persistence/persistence-api-1.0.jar" />
        <path refid="authz.classpath" />
        <fileset dir="${libDir}/cog" includes="**/*.jar" excludes="**/commons-logging-*.jar"/>
        <fileset dir="${libDir}/security" includes="**/*.jar" />
        <fileset dir="${glite.untarred}" includes="**/*.jar" />
        <fileset dir="${libDir}/terapaths" includes="*.jar" />
        <pathelement location="${libDir}/jdom/jdom.jar" />
        <pathelement location="${classesDir}/dcache.jar" />
        <pathelement location="${classesDir}/srm.jar" />
        <pathelement location="${libDir}/jpox/jdo2-api-2.0.jar" />
        <pathelement location="${libDir}/jpox/jpox-core-1.2.2.jar" />
        <pathelement location="${libDir}/Chimera/commons-cli-1.0.jar" />
    </path>



    <!-- Classpath for gplazma.jar. -->

    <path id="authz.classpath">
        <pathelement location="${classesDir}/gplazma.jar" />
        <fileset dir="${libDir}/gplazma" includes="**/*.jar" />
        <pathelement location="${libDir}/security/bcprov-jdk15-143.jar" />
        <fileset dir="${libDir}/cog" includes="**/*.jar" />
    </path>

    <!-- Classpath for enhancement -->

    <path id="dcache-srm-enhance.classpath">
        <pathelement location="${classesDir}/cells.jar" />
        <pathelement location="${libDir}/jpox/jdo2-api-2.0.jar" />
        <pathelement location="${libDir}/jpox/jpox-core-1.2.2.jar" />
        <pathelement location="${libDir}/jpox/jpox-enhancer-1.2.2.jar" />
        <pathelement location="${libDir}/jpox/logback-config" />
        <fileset dir="${libDir}/logback" includes="*.jar" />
        <pathelement location="${libDir}/asm/asm-3.1.jar" />
        <pathelement path="${dcache.build.dir}" />
        <path refid="dependency.classpath" />
    </path>


    <!--
        Targets for dcache.jar
    -->

    <!-- Depend -->

    <target name="-dcache.depend" depends="-isDependPresent" if="depend.present">
        <depend srcdir="${dcache.src}" destdir="${dcache.build.dir}" />
    </target>

    <!-- The SMC invocation part. Without the ant-contrib tasks, we
             need to add each .sm file one by one below. -->
    <!--
        Compile state machines using SMC
    -->
    <target name="-dcache.smc">
        <mkdir dir="${dcache.build.dir}/org/dcache/services/pinmanager1" />
        <mkdir dir="${dcache.build.dir}/org/dcache/pool/migration" />

        <smc target="java"
            smfile="${dcache.src}/org/dcache/services/pinmanager1/Extender.sm"
            destdir="${dcache.build.dir}/org/dcache/services/pinmanager1/"
            smcjar="${smc.jar}"
        />
        <smc target="java"
            smfile="${dcache.src}/org/dcache/services/pinmanager1/Unpinner.sm"
            destdir="${dcache.build.dir}/org/dcache/services/pinmanager1/"
            smcjar="${smc.jar}"
        />
        <smc target="java"
            smfile="${dcache.src}/org/dcache/pool/migration/Task.sm"
            destdir="${dcache.build.dir}/org/dcache/pool/migration/"
            smcjar="${smc.jar}"
        />
        <smc target="java"
            smfile="${dcache.src}/org/dcache/services/pinmanager1/Pinner.sm"
            destdir="${dcache.build.dir}/org/dcache/services/pinmanager1/"
            smcjar="${smc.jar}"
        />
        <smc target="java"
            smfile="${dcache.src}/org/dcache/services/pinmanager1/PinMover.sm"
            destdir="${dcache.build.dir}/org/dcache/services/pinmanager1/"
            smcjar="${smc.jar}"
         />

        <mkdir dir="${dcache.build.dir}/org/dcache/pool/p2p" />
        <smc target="java"
            smfile="${dcache.src}/org/dcache/pool/p2p/Companion.sm"
            destdir="${dcache.build.dir}/org/dcache/pool/p2p/"
            smcjar="${smc.jar}"
        />
    </target>

    <!--
        compile dcache code
    -->

    <target name="-dcache.compile" depends="-prepare,-dcache.smc,-dcache.depend" unless="dcache.jar.upToDate-classes">

        <mkdir dir="${dcache.build.dir}" />

        <javac destdir="${dcache.build.dir}" source="${javac.source}" target="${javac.target}" debug="${javac.debug}" verbose="${javac.verbose}" encoding="${javac.encoding}">

            <src path="${dcache.src}" />
            <src path="${dcache.build.dir}" />

            <classpath refid="dcache.classpath" />
            <classpath refid="authz.classpath" />

            <include name="diskCacheV111/**" />
            <include name="diskCacheV111/services/authorization/**" />
            <include name="org/**" />
            <exclude name="diskCacheV111/scripts/**" />
            <exclude name="diskCacheV111/tomcat/**" />
            <exclude name="org/dcache/services/plots/**/*.java" />
        </javac>

    </target>

    <path id="dcache-auth-enhance.classpath">
        <pathelement location="${classesDir}/gplazma.jar" />
        <pathelement location="${libDir}/jpox/bcel-5.1.jar" />
        <pathelement location="${libDir}/jpox/jdo2-api-2.0.jar" />
        <pathelement location="${libDir}/jpox/jpox-enhancer-1.2.2.jar" />
        <pathelement location="${libDir}/jpox/jpox-core-1.2.2.jar" />
        <pathelement location="${libDir}/jpox/jpox-java5-1.2.2.jar" />
        <pathelement location="${libDir}/jpox/jpox-rdbms-1.2.2.jar" />
        <fileset dir="${libDir}/logback" includes="*.jar" />
        <pathelement location="${libDir}/persistence/persistence-api-1.0.jar" />
        <pathelement location="${libDir}/asm/asm-3.1.jar" />
        <pathelement location="${dcache.build.dir}" />
        <path refid="dependency.classpath" />
    </path>

    <target name="-dcache-auth.check.enhanced">
        <condition property="dcache-auth.is.enhanced">
            <and>
                <available file="${dcache.build.dir}/META-INF/persistence.xml" type="file" />
            </and>
        </condition>
    </target>

    <!--
        Enhance auth record
        generate JPA Persistency code
    -->
    <target name="-dcache-auth.enhance" depends="-dcache.compile,-dcache-auth.check.enhanced" unless="dcache-auth.is.enhanced">

        <mkdir dir="${dcache.build.dir}/META-INF" />
        <copy file="${dcache.src}/diskCacheV111/config/persistence.xml" todir="${dcache.build.dir}/META-INF" />
        <copy file="${dcache.src}/org/dcache/auth/AuthRecordORM.xml" todir="${dcache.build.dir}/org/dcache/auth/" />
        <!-- define the task enhancer -->
        <taskdef name="enhancer" classname="org.jpox.enhancer.tools.EnhancerTask">
            <classpath refid="dcache-auth-enhance.classpath" />
        </taskdef>

        <!-- enhance -->
        <enhancer classpathref="dcache-auth-enhance.classpath" dir="${dcache.build.dir}"
                  api="JPA" persistenceUnit="AuthRecordPersistenceUnit"/>
    </target>

    <!--
        build dcache.jar, compile if reqiered
    -->
    <target name="-dcache.jar" depends="-isUptodate.dcache.jar,-dcache.enhance" unless="dcache.jar.upToDate">

        <mkdir dir="${dcache.build.dir}/META-INF" />
        <copy file="${dcache.src}/diskCacheV111/config/persistence.xml" todir="${dcache.build.dir}/META-INF" />
        <copy file="${dcache.src}/org/dcache/auth/AuthRecordORM.xml" todir="${dcache.build.dir}/org/dcache/auth/" />
        <jar jarfile="${dcache.jar}">
            <fileset dir="${dcache.src}" includes="**/*.xml,**/*.jdo" excludes="diskCacheV111/config/*,**/WEB-INF/*.xml" />
            <fileset dir="${dcache.build.dir}" includes="**/*.class,META-INF/*.xml" />
            <manifest>
                <section name="Shared">
                    <attribute name="Title" value="dCache Core" />
                    <attribute name="Vendor" value="${vendor}" />
                    <attribute name="Date" value="${jar.timestamp}" />
                </section>
                <section name="Copyright">
                    <attribute name="Copy" value="${copyright}" />
                </section>
                <attribute name="Main-Class" value="diskCacheV111.util.Version" />
                <attribute name="Class-Path" value="cells.jar" />
                <attribute name="Specification-Version" value="${release.name}" />
                <attribute name="Specification-Vendor" value="${vendor}" />
                <attribute name="Package-Title" value="dmg.util" />
                <attribute name="Package-Version" value="${release.name}" />
                <attribute name="Package-Vendor" value="${vendor}" />
            </manifest>
        </jar>

    </target>

    <!-- Enhance -->

    <!--
        generate JDO persistency backend
    -->
    <target name="-dcache.enhance" depends="-dcache.compile">
            <java classname="org.jpox.enhancer.JPOXEnhancer" classpathref="dcache-srm-enhance.classpath" fork="true" failonerror="true">
            <arg value="${dcache.src}/diskCacheV111/services/package.jdo" />
            <sysproperty key="log4j.configuration" value="file:${dcache.src}/diskCacheV111/services/log4j.properties" />
        </java>
    </target>


    <!-- directory layout :

      <dCache home>-|
            |-classes
            |-jobs
            |-config-|
                               |-users-|
                                       |-acls
                                       |-meta
                                       |-relations
            |-docs-|
                   |-images
    -->


    <target name="-dcache.bin" depends="-dcache.jar">

        <mkdir dir="${server.bin.dir}/classes" />
        <mkdir dir="${server.bin.dir}/jobs" />
        <mkdir dir="${server.bin.dir}/config" />
        <mkdir dir="${server.bin.dir}/config/users" />
        <mkdir dir="${server.bin.dir}/config/users/meta" />
        <mkdir dir="${server.bin.dir}/config/users/relations" />
        <mkdir dir="${server.bin.dir}/config/users/acls" />
        <mkdir dir="${server.bin.dir}/docs" />
        <mkdir dir="${server.bin.dir}/docs/images" />
        <mkdir dir="${server.bin.dir}/docs/skins" />
        <mkdir dir="${server.bin.dir}/docs/styles" />
        <mkdir dir="${server.bin.dir}/docs/scripts" />
        <mkdir dir="${server.bin.dir}/docs/scripts/sorting" />

        <!-- jar file  -->
        <copy file="${classesDir}/dcache.jar" todir="${server.bin.dir}/classes" />

        <!-- pool setup template  -->
        <copy file="${dcache.src}/diskCacheV111/config/setup.temp" todir="${server.bin.dir}/config" />

        <!-- httpd images, etc -->
        <copy todir="${server.bin.dir}/docs/images">
            <fileset dir="${dcache.src}/diskCacheV111/docs/images" />
        </copy>
        <copy todir="${server.bin.dir}/docs/styles">
            <fileset dir="${dcache.src}/diskCacheV111/docs/styles" />
        </copy>
        <copy todir="${server.bin.dir}/docs/scripts">
            <fileset dir="${dcache.src}/diskCacheV111/docs/scripts" />
        </copy>
        <copy file="${dcache.src}/diskCacheV111/docs/skins/home-skin-basic.html" todir="${server.bin.dir}/docs/skins" />
        <copy file="${dcache.src}/diskCacheV111/docs/statisticsHelp.html" todir="${server.bin.dir}/docs" />

        <!-- HSM flush scripts -->
        <copy file="${dcache.src}/diskCacheV111/jobs/encp.sh" todir="${server.bin.dir}/jobs" />
        <copy file="${dcache.src}/diskCacheV111/jobs/hsmcp.sh" todir="${server.bin.dir}/jobs" />
        <copy file="${dcache.src}/diskCacheV111/jobs/hsmcpV4.sh" todir="${server.bin.dir}/jobs" />
        <copy file="${dcache.src}/diskCacheV111/jobs/hsmcp.rb" todir="${server.bin.dir}/jobs" />

        <chmod dir="${server.bin.dir}/jobs" includes="**/*" perm="ugo+rx" />

        <!-- Chimera -->
        <mkdir dir="${server.bin.dir}/classes/chimera" />
        <copy file="${libDir}/Chimera/chimera-core.jar" todir="${server.bin.dir}/classes/chimera" />
        <copy file="${libDir}/Chimera/chimera-config.xml" todir="${server.bin.dir}/config" />
        <copy file="${libDir}/Chimera/oncrpc.jar" todir="${server.bin.dir}/classes/chimera" />
        <copy file="${libDir}/Chimera/portmap.jar" todir="${server.bin.dir}/classes/chimera" />
        <copy file="${libDir}/Chimera/commons-cli-1.0.jar" todir="${server.bin.dir}/classes/chimera" />
        <copy file="${libDir}/Chimera/chimera-get-acl.sh" tofile="${server.bin.dir}/libexec/chimera/chimera-get-acl.sh" />
        <copy file="${libDir}/Chimera/chimera-set-acl.sh" tofile="${server.bin.dir}/libexec/chimera/chimera-set-acl.sh" />
        <copy file="${libDir}/Chimera/chimera-cli.sh" tofile="${server.bin.dir}/libexec/chimera/chimera-cli.sh" />
        <chmod file="${server.bin.dir}/libexec/chimera/chimera-set-acl.sh" perm="ugo+rx" />
        <chmod file="${server.bin.dir}/libexec/chimera/chimera-get-acl.sh" perm="ugo+rx" />
        <chmod file="${server.bin.dir}/libexec/chimera/pnfs2chimera.sh" perm="ugo+rx" />
        <chmod file="${server.bin.dir}/libexec/chimera/pool2chimera.sh" perm="ugo+rx" />
        <chmod file="${server.bin.dir}/libexec/chimera/chimera-cli.sh" perm="ugo+rx" />
        <copy todir="${server.bin.dir}/libexec/chimera/sql">
            <fileset dir="${libDir}/Chimera/sql" />
        </copy>

        <!-- ACL -->
        <!--<copy file="${buildTop}/common/acl.properties" todir="${server.bin.dir}/config" /> -->

        <!-- glite -->
        <mkdir dir="${server.bin.dir}/classes/glite" />
        <copy todir="${server.bin.dir}/classes/glite" flatten="true">
            <fileset dir="${glite.untarred}">
                <include name="**/*.jar" />
            </fileset>
        </copy>

        <!-- logback -->
        <mkdir dir="${server.bin.dir}/classes/logback" />
        <copy todir="${server.bin.dir}/classes/logback">
          <fileset dir="${libDir}/logback/">
            <include name="*.jar" />
          </fileset>
        </copy>

        <!-- Wicket -->
        <mkdir dir="${server.bin.dir}/classes/wicket" />
	<copy todir="${server.bin.dir}/classes/wicket">
            <fileset dir="${libDir}/wicket">
		<include name="*.jar" />
            </fileset>
	</copy>

        <!-- SMC -->
        <mkdir dir="${server.bin.dir}/classes/smc/" />
        <copy file="${libDir}/smc/statemap.jar" todir="${server.bin.dir}/classes/smc/" />

        <!-- Parboiled -->
        <mkdir dir="${server.bin.dir}/classes/parboiled4j/" />
        <copy todir="${server.bin.dir}/classes/parboiled4j">
            <fileset dir="${libDir}/parboiled4j/">
                <include name="*.jar" />
            </fileset>
        </copy>

        <!-- TopLink files -->
        <mkdir dir="${server.bin.dir}/classes/toplink" />
        <copy file="${libDir}/toplink/toplink-essentials.jar" todir="${server.bin.dir}/classes/toplink" />

        <!-- opensaml -->
        <mkdir dir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/commons-collections-3.1.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/commons-lang-2.1.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/joda-time-1.5.2.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/opensaml-1.0.1.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/opensaml-2.2.0.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/openws-1.1.0.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/velocity-1.5.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/xalan-2.6.0.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/xml-security-1.4.1.jar" todir="${server.bin.dir}/classes/opensaml" />
        <copy file="${libDir}/opensaml/xmltooling-1.0.1.jar" todir="${server.bin.dir}/classes/opensaml" />

        <!-- endorsed -->
        <mkdir dir="${server.bin.dir}/classes/endorsed" />
        <copy file="${libDir}/endorsed/xml-apis-2.9.1.jar" todir="${server.bin.dir}/classes/endorsed" />
        <copy file="${libDir}/endorsed/xercesImpl-2.9.1.jar" todir="${server.bin.dir}/classes/endorsed" />

        <!-- jar file  -->
        <copy file="${classesDir}/srm.jar" todir="${server.bin.dir}/classes" />
        <copy file="${classesDir}/cells-protocols.jar" todir="${server.bin.dir}/classes" />

        <!-- Web services stuff   -->
        <copy file="${dcache.src}/diskCacheV111/config/JHRM.map" todir="${server.bin.dir}/config" />

        <!-- most of this stuff have nothing to do with dCache, but I can't find beter place -->

        <!-- external jars -->

        <!-- cog -->
        <mkdir dir="${server.bin.dir}/classes/cog" />
        <property name="cogVersion" value="cog-srmlib" />
        <copy todir="${server.bin.dir}/classes/cog">
            <fileset dir="${libDir}/cog/${cogVersion}">
                <include name="*.jar" />
                <exclude name="commons-logging-*.jar"/>
            </fileset>
        </copy>

        <!-- jdom -->
        <mkdir dir="${server.bin.dir}/classes/jdom" />
        <copy file="${libDir}/jdom/jdom.jar" todir="${server.bin.dir}/classes/jdom" />

        <!-- gplazma -->
        <mkdir dir="${server.bin.dir}/classes/gplazma" />
        <copy todir="${server.bin.dir}/classes/gplazma">
            <fileset dir="${libDir}/gplazma">
                <include name="*.jar" />
            </fileset>
        </copy>

        <!-- jpox -->
        <mkdir dir="${server.bin.dir}/classes/jpox" />
        <copy file="${libDir}/jpox/jdo2-api-2.0.jar" todir="${server.bin.dir}/classes/jpox" />
        <copy file="${libDir}/jpox/jpox-core-1.2.2.jar" todir="${server.bin.dir}/classes/jpox" />
        <copy file="${libDir}/jpox/jpox-rdbms-1.2.2.jar" todir="${server.bin.dir}/classes/jpox" />

        <!-- bouncy castle -->
        <mkdir dir="${server.bin.dir}/classes/security" />
        <copy todir="${server.bin.dir}/classes/security">
            <fileset dir="${libDir}/security">
                <include name="bcprov-jdk15-143.jar" />
            </fileset>
        </copy>

        <!-- terapaths -->
        <mkdir dir="${server.bin.dir}/classes/terapaths" />
        <copy todir="${server.bin.dir}/classes/terapaths">
            <fileset dir="${libDir}/terapaths">
                <include name="*.jar" />
            </fileset>
        </copy>

         <!-- rrd4j -->
        <mkdir dir="${server.bin.dir}/classes/rrd4j" />
        <copy todir="${server.bin.dir}/classes/rrd4j">
            <fileset dir="${libDir}/rrd4j">
                <include name="*.jar" />
            </fileset>
        </copy>

	<!-- Saxon (needed as XSLT for Xylophone) -->
	<mkdir dir="${server.bin.dir}/classes/saxon" />
	<copy todir="${server.bin.dir}/classes/saxon">
	  <fileset dir="${libDir}/saxon">
	    <include name="*.jar" />
	  </fileset>
	</copy>

        <!-- external libraries -->
        <mkdir dir="${server.bin.dir}/classes/lib" />
        <copy todir="${server.bin.dir}/classes/lib">
            <fileset refid="dependency.fileset" />
            <!-- This mapper strips off all leading directory information -->
            <mapper type="flatten" />
         </copy>

    </target>


    <property name="batik.home" location="${libDir}/batik-1.7" />
    <property name="output.image" value="${server.bin.dir}/docs/images/bg.jpg" />
    <property name="input.svg" value="dCache-web-bg-logo.svg" />

    <target name="-is.batik.present" >
        <condition property="batik.present">
            <and>
                <available file="${batik.home}" type="dir" />
                <!--The openjdk available at macports does not come with a sun proprietary api required by batik. Please remove this once this shortcomming has been addressed. -->
                <not><os name="Darwin" /></not>
            </and>
        </condition>

    </target>

    <!--
        generate dcache home page background images with version number
    -->
    <target name="-gen.bg.image" depends="-is.batik.present" if="batik.present" >

        <mkdir dir="${buildDir}/batik" />
        <taskdef name="rasterize" classname="org.apache.tools.ant.taskdefs.optional.RasterizerTask">
            <classpath>
                <pathelement location="${batik.home}/batik-rasterizer.jar" />
                <pathelement location="${batik.home}/RasterizerTask.jar" />
            </classpath>
        </taskdef>

        <copy todir="${buildDir}/batik" file="${dcache.src}/diskCacheV111/docs/images/${input.svg}"
            overwrite="true">
            <filterset>
                <filter token="VERSION" value="${version}-${patch}"/>
            </filterset>
        </copy>

        <echo message="Generating version specific backgroud image" />
        <rasterize result="image/jpeg" src="${buildDir}/batik/${input.svg}"
            dest="${output.image}"
        />

    </target>

</project>

