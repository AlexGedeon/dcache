<html>
<head><title>Stk Library Server Communication Protocol</title></head>


<body bgcolor=white>
<h1>Stk Library Server : Communication Level Protocol</h1>
<h2>General Considerations</h2>
<ul>
<li>Common data area. (possibly of fixed size )
<li>No system support of atomic read-modify-write.
<li>Result : exactly one server and one client instance.
<li>Only ASCII characters. 
<li>End of Information can be 
    <ul>
    <li>End of fixed data area (padded with blanks)
    <li>binary '\0'
    </ul>
<li>Requests and replies are tokenizable strings.
<li>Tokens are separated by 'blanks'. Tokens can be enclosed in quotes.
<li>Commands and replies have standard action ids for convenience.
    (details see <a href="LsAppProtocol.html">Application Protocol</a>)
<li>Strong <a href=#sem>synchronous client server handshake</a>. 
    Request from client, reply from server.
<li>Library server is the protocol client and the GUI is the protocol server.
</ul>
<h2>Common Data Area layout</h2>
The comman data area is designed to handle multiple drives. Each drive 
is represented by the so called <i>Drive Section</i>.
A drive section occupies exactly 512 byte of data. Drive sections
are contiguous.
<p>
The first 32 bytes of a drive section contains the
drive specifier (the drive name). The drive specifier must
not exceed 32 bytes. Residual bytes are padded with blanks.
<h3>The drive section</h3>
<pre>
   0         0         0         0                      5
   0         1         2         3                      1
   012345678901234567890123456789012345         ... 6789012
   &lt;driveName&gt;                     S &lt;command area&gt;
</pre>
<blockquote>
  <strong>&lt;driveName&gt;</strong>The unique identifier for this
  Drive. This name is displayed together with the mount/dismount
  request.
  <p>
  <strong>S</strong> The semaphore protecting this section. 
    See <a href="#sem">Synchronous Client Server Handshake</a> for further
    description  of the handshake.
  <p>
  <strong>&lt;command area&gt;</strong> The command area contains the
  actual commands described in 
  <a href="LsAppProtocol.html">Application Protocol</a>.
  <p>
</blockquote)
<a name=sem></a>
<h2>Synchronous Client Server Handshake</h2>
The first character of the common data area is used as semaphore, to define
the ownership of the residual data area.
Because no hardware support of atomic read-modify-write cycles are 
supported, the protocol only allows exactly one server and one client instance.
The client indicates its ownership by the character 'c' the server by 
the character 's'.
<p>
<h4>Initialization</h4>
The protocol client ( the Library Server ) creates the area and takes ownership
by setting the semaphore to 'c'.
The server ONLY assumes the data area as valid if the first character is
the 's'.
<h4>Handshake</h4>
After initialization the client owns the area and may fill the request
string. The semaphore (first character) has to be the 'c' during this 
operation. AFTER the area is filled, the semaphore can be set to 's'.
The client is not allowed to touch or interpret the data as long
as the semaphore stays an 's'. With the appearance of the 's' as semaphore,
the server takes ownership and is allowed to interpret the command
string, perform the appropriate action and fill in the reply.
AFTER the reply has been written, the semaphore needs to be set to
'c' to move the ownership to the client again.
<h4>Example</h4>
<table border=1 bgcolor=#eeeeee>
<tr><th>Semaphore</th><th>Command Area</th><th>client</th><th>server</th>
<tr><td align=center>c</td>
    <td></td>
    <td align=center>-</td>
    <td align=center>waits for s</td>
</tr>
<tr><td align=center>c</td>
    <td>200 mount drive0 U9999</td>
    <td align=center>writes the request</td>
    <td align=center>waits for s</td>
</tr>
<tr><td align=center>s</td>
    <td>200 mount drive0 U9999</td>
    <td align=center>releases ownership</td>
    <td align=center>waits for s</td>
</tr>
<tr><td align=center>s</td>
    <td>200 mount drive0 U9999</td>
    <td align=center>waits for c</td>
    <td align=center>takes ownership</td>
</tr>
<tr><td align=center>s</td>
    <td>200 mount drive0 U9999</td>
    <td align=center>waits for c</td>
    <td align=center>reads data and reacts</td>
</tr>
<tr><td align=center>s</td>
    <td>201 mount-ok</td>
    <td align=center>waits for c</td>
    <td align=center>writes reply</td>
</tr>
<tr><td align=center>c</td>
    <td>201 mount-ok</td>
    <td align=center>waits for c</td>
    <td align=center>releases ownership</td>
</tr>
<tr><td align=center>c</td>
    <td>201 mount-ok</td>
    <td align=center>takes ownership</td>
    <td align=center>waits for s</td>
</tr>
</table>
<h4>Protocol or internal Error Handling by the server</h4>
The server has methods to inform the client of request errors or internal
server problems. (See <a href="LsAppProtocol.html#exc">Exceptional Replies</a>).
In addition, the protocol allows the server to let the client retry the request.
<h4>Protocol Error Handling by the client</h4>
If the client detects a protocol violation it may retry the request or it may
try to send a 'say' command with the 'panic option' to inform the server about the problem. 
There is no guaranty that this has any effect.
</body>
</html>
