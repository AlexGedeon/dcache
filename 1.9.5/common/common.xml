<!-- $Id: common.xml,v 1.33 2007-10-24 10:05:13 tigran Exp $ -->

<project>

    <!-- Define task for invoking SMC - the state machine compiler -->
    <taskdef name="smc" classname="net.sf.smc.ant.SmcJarWrapper" classpath="${libDir}/smc/smc-ant.jar" />
    <property name="smc.jar" location="${libDir}/smc/Smc.jar" />

    <!--
        Useful information from Environment
    -->

    <property environment="sysenv" />

    <!-- JAVAC related constants -->
    <!-- modify values in property file ant not here -->
    <property file="${buildTop}/common/javac.properties" />

    <!--
        initialize some defaults
    -->

    <tstamp>
        <format property="jar.timestamp" pattern="MM/dd/yyyy hh:mm:ss" />
        <format property="rpm.timestamp" pattern="yyyy.MM.dd" />
        <format property="sortableTimestamp" timezone="UTC" pattern="yyyyMMddHHmmss" />
    </tstamp>

    <!--
        Untar axis, glite, tomcat, cog, glue
    -->

    <property name="axis.libDir" location="${libDir}/axis" />
    <property name="axis.tarName" location="${axis.libDir}/axis-bin-1_3.tar.gz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="axis.untared" location="${unpackTop}/axis-1_3" />
    <!-- This is the dir the tar will create -->

    <target name="-check.lib.axis.uptodate" >
        <uptodate property="lib.axis.uptodate" targetfile="${axis.untared}">
            <srcfiles dir="${axis.libDir}" includes="${axis.tarName}" />
        </uptodate>
    </target>

    <target name="-lib.axis.untar" depends="-check.lib.axis.uptodate" unless="lib.axis.uptodate">
        <echo>Unpacking to ${axis.untared}</echo>
        <untar src="${axis.tarName}" dest="${unpackTop}" compression="gzip" />
    </target>

    <property name="glite.libDir" location="${libDir}/glite" />
    <property name="glite.untarred" location="${unpackTop}/share" />

    <target name="-check.lib.glite.uptodate" >
        <uptodate property="lib.glite.uptodate" targetfile="${glite.untarred}">
            <srcfiles dir="${glite.libDir}" includes="**/*.tar.gz" />
        </uptodate>
    </target>

    <target name="-lib.glite.untar" depends="-check.lib.glite.uptodate" unless="lib.glite.uptodate">
        <echo>Unpacking to ${glite.untarred}</echo>
        <untar dest="${unpackTop}" compression="gzip">
            <patternset>
                <include name="**/glite*.jar" />
		<include name="**/voms*.jar" />
            </patternset>
            <fileset dir="${glite.libDir}">
                <include name="**/*.tar.gz" />
            </fileset>
        </untar>
    </target>

    <property name="tomcat.libDir" location="${libDir}/tomcat" />
    <property name="tomcat.tarName" location="${tomcat.libDir}/apache-tomcat-5.5.20.tar.gz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="tomcat.untared" location="${unpackTop}/apache-tomcat-5.5.20" />
    <!-- This is the dir the tar will create -->

    <target name="-check.lib.tomcat.uptodate" >
        <uptodate property="lib.tomcat.uptodate" targetfile="${tomcat.untared}">
            <srcfiles dir="${tomcat.libDir}" includes="${tomcat.tarName}" />
        </uptodate>
    </target>

    <target name="-lib.tomcat.untar" depends="-check.lib.tomcat.uptodate" unless="lib.tomcat.uptodate">
        <echo>Unpacking to ${tomcat.untared}</echo>
        <untar src="${tomcat.tarName}" dest="${unpackTop}" compression="gzip" />
    </target>

    <property name="cog.libDir" value="${libDir}/cog" />

    <property name="gplazma.libDir" location="${libDir}/gplazma" />
    <property name="gplazma.tarName" location="${gplazma.libDir}/gplazma.tgz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="gplazma.untaredTo" location="${gplazma.libDir}/gplazma" />
    <!-- This is the dir the tar will create -->


    <property name="glue.libDir" location="${libDir}/glue" />
    <property name="glue.tarName" location="${glue.libDir}/glue-srmlib.tgz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="glue.untared" location="${unpackTop}/glue-srmlib" />
    <!-- This is the dir the tar will create -->

    <target name="-check.lib.glue.uptodate" >
        <uptodate property="lib.glue.uptodate" targetfile="${glue.untared}">
            <srcfiles dir="${glue.libDir}" includes="${glue.tarName}" />
        </uptodate>
    </target>

    <target name="-lib.glue.untar" depends="-check.lib.glue.uptodate" unless="lib.glue.uptodate">
        <echo>Unpacking to ${glue.untared}</echo>
        <untar src="${glue.tarName}" dest="${unpackTop}" compression="gzip" />
    </target>

    <!--
        generate dcache run-time classpath.
        generate a file with all jar files located in ${server.bin.dir}/classes
    -->
    <target name="-dcache-classpath">
        <path id="dcache.external.jars">
            <fileset dir="${server.bin.dir}/classes" includes="**/*.jar">
                <exclude name="cells.jar" />
                <exclude name="dcache.jar" />
            </fileset>
        </path>

        <!--
            replace absolute path with  ${ourHomeDir} variable
        -->
        <pathconvert property="dcache.classpath" targetos="unix" refid="dcache.external.jars">
            <map from="${server.bin.dir}/classes" to="${ourHomeDir}/classes" />
        </pathconvert>
        <echo>Generating runtime classpath...</echo>
        <echo file="${server.bin.dir}/classes/extern.classpath" append="no">externalLibsClassPath=${dcache.classpath}</echo>
    </target>

</project>
