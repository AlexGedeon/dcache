<?xml version="1.0" encoding="UTF-8"?>

<!--+
    |  The billing components for dCache instances that make use of
    |  database storage.
    +-->
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">


    <import resource="billingcell-common.xml" />


    <context:load-time-weaver/>


    <!-- rather than allow an arbitrary number of access beans, two
         singleton instances (cell, httpResponseEngine) are specified
         separately even though they are for all intents and purposes
         identical -->
    <bean id="jdbc-billing-info-access" class="${dbAccess}">
        <property name="jdbcUrl" value="${dbUrl}"/>
        <property name="jdbcDriver" value="${dbDriver}"/>
        <property name="jdbcUser" value="${dbUser}"/>
        <property name="jdbcPassword"
                  value="#{ T(diskCacheV111.util.Pgpass).getPassword('${pgPass}', '${dbUrl}', '${dbUser}', '${dbPass}') }"/>
        <property name="maxInsertsBeforeCommit"
                  value="${dbAccessMaxInsertsBeforeCommit}"/>
        <property name="maxTimeBeforeCommit"
                  value="${dbAccessMaxTimeBeforeCommit}"/>
        <property name="propertiesPath" value="${dbAccessProperties}"/>
    </bean>


    <bean id="liquibase" class="org.dcache.util.SpringLiquibase">
        <description>Database schema manager</description>
        <property name="dataSource">
            <bean class="org.springframework.jdbc.datasource.DriverManagerDataSource">
                <property name="driverClassName" value="${dbDriver}"/>
                <property name="url" value="${dbUrl}"/>
                <property name="username" value="${dbUser}"/>
                <property name="password"
                    value="#{ T(diskCacheV111.util.Pgpass).getPassword('${pgPass}', '${dbUrl}', '${dbUser}', '${dbPass}') }"/>
            </bean>
        </property>
        <property name="changeLog" value="classpath:${billingChangelog}"/>
        <property name="shouldUpdate" value="${shouldUpdate}"/>
    </bean>


    <bean id="billingcell" class="org.dcache.services.billing.cells.BillingCell" init-method="initialize">
        <property name="logsDir" value="${billingLogsDir}"/>
        <property name="disableTxt" value="${billingDisableTxt}"/>
        <property name="printMode" value="${printMode}"/>
        <property name="access" ref="jdbc-billing-info-access"/>
        <property name="poolStub" ref="pool-stub"/>
        <property name="transferMessageFormat" value="${poolTransferMessage}" />
        <property name="removeMessageFormat" value="${poolRemoveMessage}" />
        <property name="requestMessageFormat" value="${doorMessage}"/>
        <property name="storageMessageFormat" value="${storageMessage}"/>
    </bean>
</beans>
