<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd">

  <bean id="pnfs-stub" class="org.dcache.cells.CellStub">
    <description>PnfsManager communication stub</description>
    <property name="destination" value="${pnfsmanager}"/>
    <property name="timeout" value="${webdavPnfsTimeout}"/>
  </bean>

  <bean id="pool-manager-stub" class="org.dcache.cells.CellStub">
    <description>PoolManager communication stub</description>
    <property name="destination" value="${poolmanager}"/>
    <property name="timeout" value="${webdavPoolManagerTimeout}"/>
  </bean>

  <bean id="pool-stub" class="org.dcache.cells.CellStub">
    <description>Pool communication stub</description>
    <property name="timeout" value="${webdavPoolTimeout}"/>
  </bean>

  <bean id="gplazma-stub" class="org.dcache.cells.CellStub">
    <description>gPlazma communication stub</description>
    <property name="destination" value="${gplazma}"/>
    <property name="timeout" value="${webdavGplazmaTimeout}"/>
  </bean>

  <bean id="billing-stub" class="org.dcache.cells.CellStub">
    <description>Billing communication stub</description>
    <property name="destination" value="billing"/>
  </bean>

  <bean id="list-handler" class="org.dcache.util.list.ListDirectoryHandler">
    <description>Client stub for directory listing</description>
    <constructor-arg>
      <bean class="diskCacheV111.util.PnfsHandler">
        <constructor-arg ref="pnfs-stub"/>
      </bean>
    </constructor-arg>
  </bean>

  <bean id="scheduled-thread-pool"
        class="java.util.concurrent.Executors"
        factory-method="newScheduledThreadPool"
        destroy-method="shutdown">
    <description>Thread pool for scheduled activities</description>
    <constructor-arg value="2"/>
  </bean>

  <bean id="security-filter" class="org.dcache.webdav.SecurityFilter">
    <description>Handles authorization for the WebDAV door</description>
    <property name="readOnly" value="${webdavReadOnly}"/>
    <property name="anonymousAccess" value="${webdavAnonymousAccess}"/>
    <property name="useGplazmaCell" value="${useGPlazmaAuthorizationCell}"/>
    <property name="useGplazmaModule" value="${useGPlazmaAuthorizationModule}"/>
    <property name="gplazmaPolicyFilePath" value="${gplazmaPolicy}"/>
    <property name="gplazmaStub" ref="gplazma-stub"/>
  </bean>

  <bean id="logging-filter" class="org.dcache.webdav.LoggingFilter">
    <description>Logs all requests</description>
  </bean>

  <bean id="dispatch-filter"
        class="org.dcache.webdav.DcacheStandardFilter">
    <description>Dispatches HTTP requests to handlers</description>
  </bean>

  <bean id="authentication-service"
        class="com.bradmcevoy.http.AuthenticationService">
    <description>Milton authentication service</description>
  </bean>

  <bean id="response-handler"
        class="com.bradmcevoy.http.webdav.DefaultWebDavResponseHandler">
    <description>Generates WebDAV responses</description>
    <constructor-arg ref="authentication-service"/>
  </bean>

  <bean id="resource-factory" class="org.dcache.webdav.DcacheResourceFactory"
        init-method="init">
    <description>Exposes dCache resources to Milton WebDAV library</description>
    <property name="pnfsStub" ref="pnfs-stub"/>
    <property name="poolManagerStub" ref="pool-manager-stub"/>
    <property name="poolStub" ref="pool-stub"/>
    <property name="billingStub" ref="billing-stub"/>
    <property name="listHandler" ref="list-handler"/>
    <property name="rootPath" value="${webdavRootPath}"/>
    <property name="allowedPaths" value="${webdavAllowedPaths}"/>
    <property name="ioQueue" value="${webdavIoQueue}"/>
    <property name="executor" ref="scheduled-thread-pool"/>
    <property name="moverTimeout" value="${webdavMoverTimeout}"/>
    <property name="killTimeout" value="${webdavKillTimeout}"/>
    <property name="transferConfirmationTimeout" value="${webdavTransferConfirmationTimeout}"/>
    <property name="internalAddress" value="${webdavInternalAddress}"/>
    <property name="logoPath" value="${webdav.images.logo}"/>
    <property name="iconDirPath" value="${webdav.images.directory}"/>
    <property name="iconFilePath" value="${webdav.images.file}"/>
    <property name="webdavStylesheetPath" value="${webdav.style.css}"/>
  </bean>

  <bean id="milton" class="com.bradmcevoy.http.HttpManager">
    <description>Implementation of the WebDAV protocol</description>
    <constructor-arg ref="resource-factory"/>
    <constructor-arg ref="response-handler"/>
    <constructor-arg ref="authentication-service"/>
    <property name="filters">
      <list>
        <ref bean="logging-filter"/>
        <ref bean="security-filter"/>
        <ref bean="dispatch-filter"/>
      </list>
    </property>
  </bean>
</beans>