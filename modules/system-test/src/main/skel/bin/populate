#!/bin/sh

set -e

UID=$(id -u)
GID=1000
USERNAME=$(id -u -n)

bin/dcache stop

if [ ! -f etc/dcache.kpwd ]; then
    DN=$(openssl x509 -in ~/.globus/usercert.pem -subject -noout | sed -e 's/subject= *//')
    bin/dcache kpwd dcuseradd -u $UID -g $GID -h / -r / -f / \
                              -w read-write -p password -s "$DN" "$USERNAME"

    bin/dcache kpwd dcmapadd "$DN" "$USERNAME"
fi

chimera() {
    echo "chimera $@"
    bin/chimera-cli "$@"
}

if [ ! -d var/db ]; then
    bin/dcache database update

    chimera writetag / OSMTemplate "StoreName test"
    chimera writetag / sGroup "default"
    chimera chmod / 555

    chimera mkdir /tape
    chimera writetag /tape sGroup "tape"
    chimera writetag /tape RetentionPolicy CUSTODIAL
    chimera writetag /tape AccessLatency NEARLINE
    chimera chown /tape $UID
    chimera chgrp /tape $GID

    chimera mkdir /disk
    chimera writetag /disk sGroup "disk"
    chimera chown /disk $UID
    chimera chgrp /disk $GID

    chimera mkdir /resilient
    chimera writetag /resilient sGroup "resilient"
    chimera chown /resilient $UID
    chimera chgrp /resilient $GID
    chimera writetag /resilient RetentionPolicy CUSTODIAL

    chimera mkdir /reserved
    chimera writetag /reserved sGroup "reserved"
    chimera chown /reserved $UID
    chimera chgrp /reserved $GID

    chimera mkdir /public
    chimera chmod /public 777
    chimera writetag /public sGroup "public"
    chimera chown /public $UID
    chimera chgrp /public $GID

    chimera mkdir /private
    chimera chmod /private 700
    chimera writetag /private sGroup "private"
    chimera chown /private $UID
    chimera chgrp /private $GID
else
    bin/dcache database update
fi

if [ ! -f etc/hostcert.p12 ]; then
    bin/dcache import hostcert
fi

if [ ! -f etc/certificates.jks ]; then
    bin/dcache import cacerts
fi

if [ ! -f etc/linkgroup.conf ]; then
    cat > etc/linkgroup.conf <<EOF
LinkGroup sm-group
$USERNAME
EOF
fi
