#
#      WebDAV Door
#

exec file:${ourHomeDir}/share/cells/import-arguments.fragment \
    ${1} ${2} ${3} ${4} ${5} ${6} ${7} ${8} ${9} ${10}

# Define defaults
onerror continue
set context -c webdavProtocol http
set context -c webdavPnfsTimeout 120000
set context -c webdavPoolManagerTimeout 300000
set context -c webdavPoolTimeout 10000
set context -c webdavGplazmaTimeout 180000
set context -c webdavPort 2880
set context -c webdavRootPath /
set context -c webdavAllowedPaths /
set context -c webdavReadOnly false

set context -c webdavIoQueue ""
set context -c webdavKillTimeout 1500
set context -c webdavMoverTimeout 180000
set context -c webdavTransferConfirmationTimeout 60000

set context -c pnfsmanager PnfsManager
set context -c poolmanager PoolManager
set context -c gplazma gPlazma
set context -c loginBrokerUpdateTime 30
set context -c loginBrokerUpdateThreshold 0.1
set context -c loginBroker LoginBroker
set context -c useGPlazmaAuthorizationCell true
set context -c useGPlazmaAuthorizationModule false

define env webdav-http.exe enddefine
  set context -c webdavAnonymousAccess READONLY
enddefine

define env webdav-https.exe enddefine
  set context -c keyStore ${ourHomeDir}/etc/hostcert.p12
  set context -c keyStorePassword dcache
  set context -c trustStore ${ourHomeDir}/etc/certificates.jks
  set context -c trustStorePassword dcache

  set context -c webdavKeyStore ${keyStore}
  set context -c webdavKeyStorePassword ${keyStorePassword}
  set context -c webdavTrustStore ${trustStore}
  set context -c webdavTrustStorePassword ${trustStorePassword}

  set context -c webdavAnonymousAccess NONE
  set context -c webdavWantClientAuth true
  set context -c webdavNeedClientAuth false
enddefine

exec env webdav-${webdavProtocol}.exe

onerror shutdown

create org.dcache.cells.UniversalSpringCell ${0} \
   "classpath:org/dcache/webdav/webdav-${webdavProtocol}.xml \
    -keyStore=${keyStore} \
    -keyStorePassword=${keyStorePassword} \
    -trustStore=${trustStore} \
    -trustStorePassword=${trustStorePassword} \
    -webdavKeyStore=${webdavKeyStore} \
    -webdavKeyStorePassword=${webdavKeyStorePassword} \
    -webdavTrustStorePassword=${webdavTrustStorePassword} \
    -webdavPnfsTimeout=${webdavPnfsTimeout} \
    -webdavPoolManagerTimeout=${webdavPoolManagerTimeout} \
    -webdavPoolTimeout=${webdavPoolTimeout} \
    -webdavGplazmaTimeout=${webdavGplazmaTimeout} \
    -webdavPort=${webdavPort} \
    -webdavRootPath=${webdavRootPath} \
    -webdavAllowedPaths=${webdavAllowedPaths} \
    -webdavReadOnly=${webdavReadOnly} \
    -webdavAnonymousAccess=${webdavAnonymousAccess} \
    -webdavIoQueue=${webdavIoQueue} \
    -webdavKillTimeout=${webdavKillTimeout} \
    -webdavMoverTimeout=${webdavMoverTimeout} \
    -webdavTransferConfirmationTimeout=${webdavTransferConfirmationTimeout} \
    -webdavWantClientAuth=${webdavWantClientAuth} \
    -webdavNeedClientAuth=${webdavNeedClientAuth} \
    -pnfsmanager=${pnfsmanager} \
    -poolmanager=${poolmanager} \
    -gplazma=${gplazma} \
    -loginBrokerUpdateTime=${loginBrokerUpdateTime} \
    -loginBrokerUpdateThreshold=${loginBrokerUpdateThreshold} \
    -loginBroker=${loginBroker} \
    -useGPlazmaAuthorizationCell=${useGPlazmaAuthorizationCell} \
    -useGPlazmaAuthorizationModule=${useGPlazmaAuthorizationModule} \
    -export -cellClass=WebDAVDoor"
