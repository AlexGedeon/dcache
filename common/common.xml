<!-- $Id: common.xml,v 1.33 2007-10-24 10:05:13 tigran Exp $ -->

<project xmlns:artifact="antlib:org.apache.maven.artifact.ant">

    <!-- Define task for invoking SMC - the state machine compiler -->
    <taskdef name="smc" classname="net.sf.smc.ant.SmcJarWrapper" classpath="${libDir}/smc/smc-ant.jar" />
    <property name="smc.jar" location="${libDir}/smc/Smc.jar" />

    <path id="maven-ant-tasks.classpath" path="${antlib.dir}/maven-ant/maven-ant-tasks-2.1.1.jar" />
    <typedef resource="org/apache/maven/artifact/ant/antlib.xml"
           uri="antlib:org.apache.maven.artifact.ant"
           classpathref="maven-ant-tasks.classpath" />
    <!--
        Useful information from Environment
    -->

    <property environment="sysenv" />

    <!-- JAVAC related constants -->
    <!-- modify values in property file ant not here -->
    <property file="${buildTop}/common/javac.properties" />

    <!--
        initialize some defaults
    -->

    <tstamp>
        <format property="jar.timestamp" pattern="MM/dd/yyyy hh:mm:ss" />
        <format property="rpm.timestamp" pattern="yyyy.MM.dd" />
        <format property="sortableTimestamp" timezone="UTC" pattern="yyyyMMddHHmmss" />
    </tstamp>

    <!-- external dependencies -->
    <artifact:dependencies pathId="dependency.classpath" filesetId="dependency.fileset" useScope="runtime">
        <!-- Remote repositories -->
        <remoteRepository id="glassfish.repository"
                          url="http://download.java.net/maven/glassfish/" />
        <remoteRepository id="berkeleydb-je.repository"
                          url="http://download.oracle.com/maven/"/>
        <remoteRepository id="jboss-netty.repository"
                          url="http://repository.jboss.org/nexus/content/groups/public/" />

        <remoteRepository id="dcache.repository"
                          url="http://www.dcache.org/nexus/content/groups/public" />

        <!-- Suppress some dependencies: Dependencies with scope
             'provided' are not included in the runtime classpath. We
             use this to suppress jars we don't really need or get
             through other means.
        -->
        <dependency groupId="commons-logging" artifactId="commons-logging" version="1.1.1" scope="provided"/>

        <!-- external dependencies -->
        <dependency groupId="com.sun.grizzly" artifactId="grizzly-framework" version="1.9.19"/>
        <dependency groupId="org.dcache.chimera" artifactId="grizzly-rpc" version="0.0.2"/>
        <dependency groupId="org.springframework" artifactId="spring-beans" version="3.0.4.RELEASE"/>
        <dependency groupId="org.springframework" artifactId="spring-context" version="3.0.4.RELEASE"/>
        <dependency groupId="org.springframework" artifactId="spring-core" version="3.0.4.RELEASE"/>
        <dependency groupId="org.springframework" artifactId="spring-expression" version="3.0.4.RELEASE"/>
        <dependency groupId="org.springframework" artifactId="spring-jdbc" version="3.0.4.RELEASE"/>
        <dependency groupId="org.springframework" artifactId="spring-web" version="3.0.4.RELEASE"/>
        <dependency groupId="org.apache.xbean" artifactId="xbean-spring" version="3.7"/>
        <dependency groupId="org.apache.activemq" artifactId="activemq-all" version="5.4.1"/>
        <dependency groupId="org.slf4j" artifactId="slf4j-api" version="1.6.1"/>
        <dependency groupId="org.slf4j" artifactId="jcl-over-slf4j" version="1.6.1"/>
        <dependency groupId="org.slf4j" artifactId="log4j-over-slf4j" version="1.6.1"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-server" version="7.1.6.v20100715"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-deploy" version="7.1.6.v20100715"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-webapp" version="7.1.6.v20100715"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-servlets" version="7.1.6.v20100715"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-plus" version="7.1.6.v20100715"/>
        <dependency groupId="org.eclipse.jetty" artifactId="jetty-security" version="7.1.6.v20100715"/>
        <dependency groupId="javax.servlet" artifactId="servlet-api" version="2.5"/>
        <dependency groupId="com.sleepycat" artifactId="je" version="4.0.103"/>
        <dependency groupId="axis" artifactId="axis" version="1.3" />
        <dependency groupId="org.jboss.netty" artifactId="netty" version="3.2.2.Final"/>
        <dependency groupId="com.google.guava" artifactId="guava" version="r07"/>
    </artifact:dependencies>
    <!--
        Untar glite, cog, glue
    -->


    <property name="glite.libDir" location="${libDir}/glite" />
    <property name="glite.untarred" location="${unpackTop}/share" />

    <target name="-check.lib.glite.uptodate" >
        <uptodate property="lib.glite.uptodate" targetfile="${glite.untarred}">
            <srcfiles dir="${glite.libDir}" includes="**/*.tar.gz" />
        </uptodate>
    </target>

    <target name="-lib.glite.untar" depends="-check.lib.glite.uptodate" unless="lib.glite.uptodate">
        <echo>Unpacking to ${glite.untarred}</echo>
        <untar dest="${unpackTop}" compression="gzip">
            <patternset>
                <include name="**/glite*.jar" />
		<include name="**/voms*.jar" />
            </patternset>
            <fileset dir="${glite.libDir}">
                <include name="**/*.tar.gz" />
            </fileset>
        </untar>
    </target>

    <property name="cog.libDir" value="${libDir}/cog" />

    <property name="gplazma.libDir" location="${libDir}/gplazma" />
    <property name="gplazma.tarName" location="${gplazma.libDir}/gplazma.tgz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="gplazma.untaredTo" location="${gplazma.libDir}/gplazma" />
    <!-- This is the dir the tar will create -->


    <property name="glue.libDir" location="${libDir}/glue" />
    <property name="glue.tarName" location="${glue.libDir}/glue-srmlib.tgz" />
    <!-- A pattern uniquely identifying one tar file -->
    <property name="glue.untared" location="${unpackTop}/glue-srmlib" />
    <!-- This is the dir the tar will create -->

    <target name="-check.lib.glue.uptodate" >
        <uptodate property="lib.glue.uptodate" targetfile="${glue.untared}">
            <srcfiles dir="${glue.libDir}" includes="${glue.tarName}" />
        </uptodate>
    </target>

    <!--
        generate dcache run-time classpath.
    -->
    <target name="-dcache-classpath">
      <echo>Generating runtime classpath...</echo>

      <!-- First, define some patterns. -->

      <!-- dcache.jar is needed independently of other compiled code -->
      <patternset id="pattern.dcache.jars.only-dcache">
	<include name="dcache.jar"/>
      </patternset>

      <!-- all compiled jar files excluding dcache.jar -->
      <patternset id="pattern.dcache.jars.all-compiled-code-except-dcache">
	<include name="dcache-common.jar"/>
	<include name="cells.jar"/>
	<include name="cells-protocols.jar"/>
	<include name="javatunnel.jar"/>
	<include name="srm.jar"/>
	<include name="xrootd-tokenauthz.jar"/>
      </patternset>

      <!-- all other jar files are external libraries -->
      <patternset id="pattern.dcache.jars.packaged-external">
	<include name="**/*.jar"/>
	<invert>
	  <patternset refid="pattern.dcache.jars.all-compiled-code-except-dcache"/>
	  <patternset refid="pattern.dcache.jars.only-dcache"/>
	</invert>
      </patternset>


      <!-- Second, make (configurable) paths by finding matching jar files in
	   deployed directory and replacing the path up to "classes" path-element
	   with the ${dcache.paths.classes} property  -->
      <pathconvert property="dcache.jars.dcache" targetos="unix">
	<map from="${server.bin.dir}/classes" to="$${dcache.paths.classes}" />
	<path>
	  <fileset dir="${server.bin.dir}/classes">
	    <patternset refid="pattern.dcache.jars.only-dcache"/>
	  </fileset>
	</path>
      </pathconvert>

      <pathconvert property="dcache.jars.all-compiled-code-except-dcache" targetos="unix">
	<map from="${server.bin.dir}/classes" to="$${dcache.paths.classes}" />
	<path>
	  <fileset dir="${server.bin.dir}/classes">
	    <patternset refid="pattern.dcache.jars.all-compiled-code-except-dcache"/>
	  </fileset>
	</path>
      </pathconvert>

      <pathconvert property="dcache.jars.packaged-external" targetos="unix">
	<map from="${server.bin.dir}/classes" to="$${dcache.paths.classes}" />
	<path>
	  <fileset dir="${server.bin.dir}/classes">
	    <patternset refid="pattern.dcache.jars.packaged-external"/>
	  </fileset>
	</path>
      </pathconvert>

      <!-- Finally, generate the classpath.properties file -->
      <property name="classpath.properties" value="${server.bin.dir}/share/defaults/classpath.properties"/>

      <echo file="${classpath.properties}">#  -----------------------------------------------------------------------
#       Location of jar files
#  -----------------------------------------------------------------------
#   dCache startup scripts need to identify where are all the required jar
#   files.  To do this, various properties take default values from this
#   file.
#
#   The defaults in this file are declared relative to the
#   dcache.paths.classes property.  Please see the paths.properties file
#   for this property's default value.
#
#   To include additional jar files, simply define the dcache.java.classpath
#   property, either in dcache.conf or in the layout file.  Its value should
#   be a colon-separated list of (absolute) paths to the required additional
#   jar files.  Most sites will not have to do this.
#
#
#   A list of all external dependencies that are delivered with dCache.
dcache.paths.classpath.packaged-external=${dcache.jars.packaged-external}
#
#   Location of the dcache.jar file.
dcache.paths.classpath.dcache=${dcache.jars.dcache}
#
#   Location of all dCache code jar files excluding the dcache.jar file.
dcache.path.classpath.compiled-not-dcache=${dcache.jars.all-compiled-code-except-dcache}
#
#   Location of all dCache code
dcache.paths.classpath.all-compiled-code=$${dcache.paths.classpath.dcache}:$${dcache.path.classpath.compiled-not-dcache}
#
#   All external jar files, including any included by the site-admin.
dcache.paths.classpath.all-external=$${dcache.java.classpath}:$${dcache.paths.classpath.packaged-external}
#
#   The classpath used by dCache.
dcache.paths.classpath=$${dcache.paths.classpath.all-compiled-code}:$${dcache.paths.classpath.all-external}
</echo>

    </target>
    <!--
        Generate eclipse project files
    -->
    <target name="eclipse-classpath" description="creates an eclipse .classpath file">
        <pathconvert property="eclipse.entries" refid="dependency.classpath"
 pathsep="&quot;/&gt;&#10;    &lt;classpathentry kind=&quot;lib&quot; path=&quot;" />

        <echo file=".classpath"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<classpath>
    <classpathentry kind="src" path="${dcache-common.src}"/>
    <classpathentry kind="src" path="${cells.src}"/>
    <classpathentry kind="src" path="${dcache.src}"/>
    <classpathentry kind="src" path="${gplazma.src}"/>
    <classpathentry kind="src" path="${srm.src}"/>
    <classpathentry kind="src" path="${srmclient.src}"/>
    <classpathentry kind="src" path="${javatunnel.src}"/>
    <classpathentry kind="src" path="${unittest.src}"/>
    <classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER"/>
    <classpathentry kind="lib" path="${eclipse.entries}"/>
    <classpathentry kind="output" path="${buildDir}"/>
</classpath>
]]>
        </echo>
     </target>

    <target name="eclipse" description="creates an eclipse .project file" depends="eclipse-classpath">
        <echo file=".project"><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<projectDescription>
    <name>${project.name}</name>
    <comment></comment>
    <projects>
    </projects>
    <buildSpec>
        <buildCommand>
            <name>org.eclipse.jdt.core.javabuilder</name>
            <arguments>
            </arguments>
        </buildCommand>
    </buildSpec>
    <natures>
        <nature>org.eclipse.jdt.core.javanature</nature>
    </natures>
</projectDescription>
]]>
        </echo>
     </target>

</project>
